'use strict';

process.env.JOB_PLATFORM = 'DOCKER';

let sinon = require('sinon');
let should = require('should');
let logger = require('../../../../src/common/logger');
let reportEmailSender = require('../../../../src/reports/models/reportEmailSender');
let reportsManager = require('../../../../src/reports/models/reportsManager');
let jobsManager = require('../../../../src/jobs/models/jobManager');
let nodemailer = require('nodemailer');

const REPORT = {
    'test_id': 'test id',
    'revision_id': 'revision_id',
    'report_id': 'report_id',
    'test_name': 'test name',
    'report_url': 'http://www.zooz.com',
    'last_stats': {
        'timestamp': '2018-05-28T15:40:10.044Z',
        'scenariosCreated': 289448,
        'scenariosCompleted': 289447,
        'requestsCompleted': 694611,
        'latency': {
            'min': 6.3,
            'max': 3822.8,
            'median': 58.8,
            'p95': 115.5,
            'p99': 189.4
        },
        'rps': {
            'count': 694611,
            'mean': 178.61
        },
        'scenarioDuration': {
            'min': 80.4,
            'max': 5251.7,
            'median': 146.8,
            'p95': 244.4,
            'p99': 366.6
        },
        'scenarioCounts': {
            'Create token and get token': 173732,
            'Create token, create customer and assign token to customer': 115716
        },
        'errors': { EAI_AGAIN: 112, NOTREACH: 123 },
        'codes': {
            '200': 173732,
            '201': 520878,
            '503': 1
        },
        'matches': 0,
        'customStats': {},
        'concurrency': 1510,
        'pendingRequests': 1471
    },
    'end_time': 1527533519591,
    'start_time': 1527533459591
};

const JOB = {
    'emails': 'eli@zooz.com'
};

const transporter = {
    sendMail: () => { },
    close: () => { }
};

describe('Report emails sender test', () => {
    let sandbox, getReportStub, getJobStub, loggerErrorStub, loggerInfoStub, nodemailerCreateTransportStub, sendMailStub;

    before(() => {
        sandbox = sinon.sandbox.create();
        getReportStub = sandbox.stub(reportsManager, 'getReport');
        getJobStub = sandbox.stub(jobsManager, 'getJob');
        loggerErrorStub = sandbox.stub(logger, 'error');
        loggerInfoStub = sandbox.stub(logger, 'info');
        nodemailerCreateTransportStub = sandbox.stub(nodemailer, 'createTransport');
        sendMailStub = sandbox.stub(transporter, 'sendMail');
    });

    beforeEach(() => {
        sandbox.resetHistory();
    });

    after(() => {
        sandbox.restore();
    });

    it('Send aggregate report successfully', async () => {
        sendMailStub.resolves({ status: 201 });
        nodemailerCreateTransportStub.returns(transporter);
        getReportStub.resolves(REPORT);
        getJobStub.resolves(JOB);

        await reportEmailSender.sendAggregateReport('testId', 'reportId', 'http://report.zooz.com', 'http://grafana.zooz.com');

        sendMailStub.callCount.should.equal(1);
        sendMailStub.args.should.containDeep([
            [
                {
                    from: 'Predator ðŸ’ª <performance@predator.com>',
                    to: [JOB.emails].join(','),
                    html: '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional //EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n<!-- saved from url=(0119)https://elin1.createsend.com/t/ViewEmail/j/0C8799AC84E65C602540EF23F30FEDED/C67FD2F38AC4859C/?tx=0&previewAll=1&print=1 -->\n<html style="margin: 0;padding: 0;" xmlns="http://www.w3.org/1999/xhtml"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">\n\n    <title></title>\n    <!--[if !mso]><!--><meta http-equiv="X-UA-Compatible" content="IE=edge"><!--<![endif]-->\n    <meta name="viewport" content="width=device-width"><style type="text/css">\n        @media only screen and (min-width: 620px){.wrapper{min-width:600px !important}.wrapper h1{}.wrapper h1{font-size:64px !important;line-height:63px !important}.wrapper h2{}.wrapper h2{font-size:30px !important;line-height:38px !important}.wrapper h3{}.wrapper h3{font-size:22px !important;line-height:31px !important}.column{}.wrapper .size-8{font-size:8px !important;line-height:14px !important}.wrapper .size-9{font-size:9px !important;line-height:16px !important}.wrapper .size-10{font-size:10px !important;line-height:18px !important}.wrapper .size-11{font-size:11px !important;line-height:19px !important}.wrapper .size-12{font-size:12px !important;line-height:19px !important}.wrapper .size-13{font-size:13px !important;line-height:21px !important}.wrapper .size-14{font-size:14px !important;line-height:21px !important}.wrapper .size-15{font-size:15px !important;line-height:23px\n        !important}.wrapper .size-16{font-size:16px !important;line-height:24px !important}.wrapper .size-17{font-size:17px !important;line-height:26px !important}.wrapper .size-18{font-size:18px !important;line-height:26px !important}.wrapper .size-20{font-size:20px !important;line-height:28px !important}.wrapper .size-22{font-size:22px !important;line-height:31px !important}.wrapper .size-24{font-size:24px !important;line-height:32px !important}.wrapper .size-26{font-size:26px !important;line-height:34px !important}.wrapper .size-28{font-size:28px !important;line-height:36px !important}.wrapper .size-30{font-size:30px !important;line-height:38px !important}.wrapper .size-32{font-size:32px !important;line-height:40px !important}.wrapper .size-34{font-size:34px !important;line-height:43px !important}.wrapper .size-36{font-size:36px !important;line-height:43px !important}.wrapper\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   .size-40{font-size:40px !important;line-height:47px !important}.wrapper .size-44{font-size:44px !important;line-height:50px !important}.wrapper .size-48{font-size:48px !important;line-height:54px !important}.wrapper .size-56{font-size:56px !important;line-height:60px !important}.wrapper .size-64{font-size:64px !important;line-height:63px !important}}\n    </style>\n    <style type="text/css">\n        body {\n            margin: 0;\n            padding: 0;\n        }\n        table {\n            border-collapse: collapse;\n            table-layout: fixed;\n        }\n        * {\n            line-height: inherit;\n        }\n        [x-apple-data-detectors],\n        [href^="tel"],\n        [href^="sms"] {\n            color: inherit !important;\n            text-decoration: none !important;\n        }\n        .wrapper .footer__share-button a:hover,\n        .wrapper .footer__share-button a:focus {\n            color: #ffffff !important;\n        }\n        .btn a:hover,\n        .btn a:focus,\n        .footer__share-button a:hover,\n        .footer__share-button a:focus,\n        .email-footer__links a:hover,\n        .email-footer__links a:focus {\n            opacity: 0.8;\n        }\n        .preheader,\n        .header,\n        .layout,\n        .column {\n            transition: width 0.25s ease-in-out, max-width 0.25s ease-in-out;\n        }\n        .preheader td {\n            padding-bottom: 8px;\n        }\n        .layout,\n        div.header {\n            max-width: 400px !important;\n            -fallback-width: 95% !important;\n            width: calc(100% - 20px) !important;\n        }\n        div.preheader {\n            max-width: 360px !important;\n            -fallback-width: 90% !important;\n            width: calc(100% - 60px) !important;\n        }\n        .snippet,\n        .webversion {\n            Float: none !important;\n        }\n        .column {\n            max-width: 400px !important;\n            width: 100% !important;\n        }\n        .fixed-width.has-border {\n            max-width: 402px !important;\n        }\n        .fixed-width.has-border .layout__inner {\n            box-sizing: border-box;\n        }\n        .snippet,\n        .webversion {\n            width: 50% !important;\n        }\n        .ie .btn {\n            width: 100%;\n        }\n        [owa] .column div,\n        [owa] .column button {\n            display: block !important;\n        }\n        .ie .column,\n        [owa] .column,\n        .ie .gutter,\n        [owa] .gutter {\n            display: table-cell;\n            float: none !important;\n            vertical-align: top;\n        }\n        .ie div.preheader,\n        [owa] div.preheader,\n        .ie .email-footer,\n        [owa] .email-footer {\n            max-width: 560px !important;\n            width: 560px !important;\n        }\n        .ie .snippet,\n        [owa] .snippet,\n        .ie .webversion,\n        [owa] .webversion {\n            width: 280px !important;\n        }\n        .ie div.header,\n        [owa] div.header,\n        .ie .layout,\n        [owa] .layout,\n        .ie .one-col .column,\n        [owa] .one-col .column {\n            max-width: 600px !important;\n            width: 600px !important;\n        }\n        .ie .fixed-width.has-border,\n        [owa] .fixed-width.has-border,\n        .ie .has-gutter.has-border,\n        [owa] .has-gutter.has-border {\n            max-width: 602px !important;\n            width: 602px !important;\n        }\n        .ie .two-col .column,\n        [owa] .two-col .column {\n            max-width: 300px !important;\n            width: 300px !important;\n        }\n        .ie .three-col .column,\n        [owa] .three-col .column,\n        .ie .narrow,\n        [owa] .narrow {\n            max-width: 200px !important;\n            width: 200px !important;\n        }\n        .ie .wide,\n        [owa] .wide {\n            width: 400px !important;\n        }\n        .ie .two-col.has-gutter .column,\n        [owa] .two-col.x_has-gutter .column {\n            max-width: 290px !important;\n            width: 290px !important;\n        }\n        .ie .three-col.has-gutter .column,\n        [owa] .three-col.x_has-gutter .column,\n        .ie .has-gutter .narrow,\n        [owa] .has-gutter .narrow {\n            max-width: 188px !important;\n            width: 188px !important;\n        }\n        .ie .has-gutter .wide,\n        [owa] .has-gutter .wide {\n            max-width: 394px !important;\n            width: 394px !important;\n        }\n        .ie .two-col.has-gutter.has-border .column,\n        [owa] .two-col.x_has-gutter.x_has-border .column {\n            max-width: 292px !important;\n            width: 292px !important;\n        }\n        .ie .three-col.has-gutter.has-border .column,\n        [owa] .three-col.x_has-gutter.x_has-border .column,\n        .ie .has-gutter.has-border .narrow,\n        [owa] .has-gutter.x_has-border .narrow {\n            max-width: 190px !important;\n            width: 190px !important;\n        }\n        .ie .has-gutter.has-border .wide,\n        [owa] .has-gutter.x_has-border .wide {\n            max-width: 396px !important;\n            width: 396px !important;\n        }\n        .ie .fixed-width .layout__inner {\n            border-left: 0 none white !important;\n            border-right: 0 none white !important;\n        }\n        .ie .layout__edges {\n            display: none;\n        }\n        .mso .layout__edges {\n            font-size: 0;\n        }\n        .layout-fixed-width,\n        .mso .layout-full-width {\n            background-color: #ffffff;\n        }\n        @media only screen and (min-width: 620px) {\n            .column,\n            .gutter {\n                display: table-cell;\n                Float: none !important;\n                vertical-align: top;\n            }\n            div.preheader,\n            .email-footer {\n                max-width: 560px !important;\n                width: 560px !important;\n            }\n            .snippet,\n            .webversion {\n                width: 280px !important;\n            }\n            div.header,\n            .layout,\n            .one-col .column {\n                max-width: 600px !important;\n                width: 600px !important;\n            }\n            .fixed-width.has-border,\n            .fixed-width.ecxhas-border,\n            .has-gutter.has-border,\n            .has-gutter.ecxhas-border {\n                max-width: 602px !important;\n                width: 602px !important;\n            }\n            .two-col .column {\n                max-width: 300px !important;\n                width: 300px !important;\n            }\n            .three-col .column,\n            .column.narrow {\n                max-width: 200px !important;\n                width: 200px !important;\n            }\n            .column.wide {\n                width: 400px !important;\n            }\n            .two-col.has-gutter .column,\n            .two-col.ecxhas-gutter .column {\n                max-width: 290px !important;\n                width: 290px !important;\n            }\n            .three-col.has-gutter .column,\n            .three-col.ecxhas-gutter .column,\n            .has-gutter .narrow {\n                max-width: 188px !important;\n                width: 188px !important;\n            }\n            .has-gutter .wide {\n                max-width: 394px !important;\n                width: 394px !important;\n            }\n            .two-col.has-gutter.has-border .column,\n            .two-col.ecxhas-gutter.ecxhas-border .column {\n                max-width: 292px !important;\n                width: 292px !important;\n            }\n            .three-col.has-gutter.has-border .column,\n            .three-col.ecxhas-gutter.ecxhas-border .column,\n            .has-gutter.has-border .narrow,\n            .has-gutter.ecxhas-border .narrow {\n                max-width: 190px !important;\n                width: 190px !important;\n            }\n            .has-gutter.has-border .wide,\n            .has-gutter.ecxhas-border .wide {\n                max-width: 396px !important;\n                width: 396px !important;\n            }\n        }\n        @media only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (min--moz-device-pixel-ratio: 2), only screen and (-o-min-device-pixel-ratio: 2/1), only screen and (min-device-pixel-ratio: 2), only screen and (min-resolution: 192dpi), only screen and (min-resolution: 2dppx) {\n            .fblike {\n                background-image: url(https://i10.createsend1.com/static/eb/master/13-the-blueprint-3/images/fblike@2x.png) !important;\n            }\n            .tweet {\n                background-image: url(https://i7.createsend1.com/static/eb/master/13-the-blueprint-3/images/tweet@2x.png) !important;\n            }\n            .linkedinshare {\n                background-image: url(https://i8.createsend1.com/static/eb/master/13-the-blueprint-3/images/lishare@2x.png) !important;\n            }\n            .forwardtoafriend {\n                background-image: url(https://i9.createsend1.com/static/eb/master/13-the-blueprint-3/images/forward@2x.png) !important;\n            }\n        }\n        @media (max-width: 321px) {\n            .fixed-width.has-border .layout__inner {\n                border-width: 1px 0 !important;\n            }\n            .layout,\n            .column {\n                min-width: 320px !important;\n                width: 320px !important;\n            }\n            .border {\n                display: none;\n            }\n        }\n        .mso div {\n            border: 0 none white !important;\n        }\n        .mso .w560 .divider {\n            Margin-left: 260px !important;\n            Margin-right: 260px !important;\n        }\n        .mso .w360 .divider {\n            Margin-left: 160px !important;\n            Margin-right: 160px !important;\n        }\n        .mso .w260 .divider {\n            Margin-left: 110px !important;\n            Margin-right: 110px !important;\n        }\n        .mso .w160 .divider {\n            Margin-left: 60px !important;\n            Margin-right: 60px !important;\n        }\n        .mso .w354 .divider {\n            Margin-left: 157px !important;\n            Margin-right: 157px !important;\n        }\n        .mso .w250 .divider {\n            Margin-left: 105px !important;\n            Margin-right: 105px !important;\n        }\n        .mso .w148 .divider {\n            Margin-left: 54px !important;\n            Margin-right: 54px !important;\n        }\n        .mso .size-8,\n        .ie .size-8 {\n            font-size: 8px !important;\n            line-height: 14px !important;\n        }\n        .mso .size-9,\n        .ie .size-9 {\n            font-size: 9px !important;\n            line-height: 16px !important;\n        }\n        .mso .size-10,\n        .ie .size-10 {\n            font-size: 10px !important;\n            line-height: 18px !important;\n        }\n        .mso .size-11,\n        .ie .size-11 {\n            font-size: 11px !important;\n            line-height: 19px !important;\n        }\n        .mso .size-12,\n        .ie .size-12 {\n            font-size: 12px !important;\n            line-height: 19px !important;\n        }\n        .mso .size-13,\n        .ie .size-13 {\n            font-size: 13px !important;\n            line-height: 21px !important;\n        }\n        .mso .size-14,\n        .ie .size-14 {\n            font-size: 14px !important;\n            line-height: 21px !important;\n        }\n        .mso .size-15,\n        .ie .size-15 {\n            font-size: 15px !important;\n            line-height: 23px !important;\n        }\n        .mso .size-16,\n        .ie .size-16 {\n            font-size: 16px !important;\n            line-height: 24px !important;\n        }\n        .mso .size-17,\n        .ie .size-17 {\n            font-size: 17px !important;\n            line-height: 26px !important;\n        }\n        .mso .size-18,\n        .ie .size-18 {\n            font-size: 18px !important;\n            line-height: 26px !important;\n        }\n        .mso .size-20,\n        .ie .size-20 {\n            font-size: 20px !important;\n            line-height: 28px !important;\n        }\n        .mso .size-22,\n        .ie .size-22 {\n            font-size: 22px !important;\n            line-height: 31px !important;\n        }\n        .mso .size-24,\n        .ie .size-24 {\n            font-size: 24px !important;\n            line-height: 32px !important;\n        }\n        .mso .size-26,\n        .ie .size-26 {\n            font-size: 26px !important;\n            line-height: 34px !important;\n        }\n        .mso .size-28,\n        .ie .size-28 {\n            font-size: 28px !important;\n            line-height: 36px !important;\n        }\n        .mso .size-30,\n        .ie .size-30 {\n            font-size: 30px !important;\n            line-height: 38px !important;\n        }\n        .mso .size-32,\n        .ie .size-32 {\n            font-size: 32px !important;\n            line-height: 40px !important;\n        }\n        .mso .size-34,\n        .ie .size-34 {\n            font-size: 34px !important;\n            line-height: 43px !important;\n        }\n        .mso .size-36,\n        .ie .size-36 {\n            font-size: 36px !important;\n            line-height: 43px !important;\n        }\n        .mso .size-40,\n        .ie .size-40 {\n            font-size: 40px !important;\n            line-height: 47px !important;\n        }\n        .mso .size-44,\n        .ie .size-44 {\n            font-size: 44px !important;\n            line-height: 50px !important;\n        }\n        .mso .size-48,\n        .ie .size-48 {\n            font-size: 48px !important;\n            line-height: 54px !important;\n        }\n        .mso .size-56,\n        .ie .size-56 {\n            font-size: 56px !important;\n            line-height: 60px !important;\n        }\n        .mso .size-64,\n        .ie .size-64 {\n            font-size: 64px !important;\n            line-height: 63px !important;\n        }\n    </style>\n\n    <style type="text/css">\n        body{background-color:#fff}.logo a:hover,.logo a:focus{color:#859bb1 !important}.mso .layout-has-border{border-top:1px solid #ccc;border-bottom:1px solid #ccc}.mso .layout-has-bottom-border{border-bottom:1px solid #ccc}.mso .border,.ie .border{background-color:#ccc}.mso h1,.ie h1{}.mso h1,.ie h1{font-size:64px !important;line-height:63px !important}.mso h2,.ie h2{}.mso h2,.ie h2{font-size:30px !important;line-height:38px !important}.mso h3,.ie h3{}.mso h3,.ie h3{font-size:22px !important;line-height:31px !important}.mso .layout__inner,.ie .layout__inner{}.mso .footer__share-button p{}.mso .footer__share-button p{font-family:sans-serif}\n    </style><meta name="robots" content="noindex,nofollow">\n    <meta property="og:title" content="My First Campaign">\n</head>\n<!--[if mso]>\n<body class="mso">\n<![endif]-->\n<!--[if !mso]><!-->\n<body class="no-padding" style="margin: 0;padding: 0;-webkit-text-size-adjust: 100%;">\n<!--<![endif]-->\n<table class="wrapper" style="border-collapse: collapse;table-layout: fixed;min-width: 320px;width: 100%;background-color: #fff;" cellpadding="0" cellspacing="0" role="presentation"><tbody><tr><td>\n    <div role="banner">\n        <div class="preheader" style="Margin: 0 auto;max-width: 560px;min-width: 280px; width: 280px;width: calc(28000% - 167440px);">\n            <div style="border-collapse: collapse;display: table;width: 100%;">\n                <!--[if (mso)|(IE)]><table align="center" class="preheader" cellpadding="0" cellspacing="0" role="presentation"><tr><td style="width: 280px" valign="top"><![endif]-->\n                <div class="snippet" style="display: table-cell;Float: left;font-size: 12px;line-height: 19px;max-width: 280px;min-width: 140px; width: 140px;width: calc(14000% - 78120px);padding: 10px 0 5px 0;color: #adb3b9;font-family: sans-serif;">\n\n                </div>\n                <!--[if (mso)|(IE)]></td><td style="width: 280px" valign="top"><![endif]-->\n                <!--[if (mso)|(IE)]></td></tr></table><![endif]-->\n            </div>\n        </div>\n\n    </div>\n    <div role="section">\n        <div style="background-color: #281557;">\n            <div class="layout three-col" style="Margin: 0 auto;max-width: 600px;min-width: 320px; width: 320px;width: calc(28000% - 167400px);overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;">\n                <div class="layout__inner" style="border-collapse: collapse;display: table;width: 100%;">\n                    <!--[if (mso)|(IE)]><table width="100%" cellpadding="0" cellspacing="0" role="presentation"><tr class="layout-full-width" style="background-color: #281557;"><td class="layout__edges">&nbsp;</td><td style="width: 200px" valign="top" class="w160"><![endif]-->\n                    <div class="column" style="Float: left;max-width: 320px;min-width: 200px; width: 320px;width: calc(72200px - 12000%);text-align: left;color: #8e959c;font-size: 14px;line-height: 21px;font-family: sans-serif;">\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 10px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                                <h3 class="size-12" style="Margin-top: 0;Margin-bottom: 0;font-style: normal;font-weight: normal;color: #281557;font-size: 12px;line-height: 19px;font-family: Avenir,sans-serif;text-align: center;" lang="x-size-12"><strong><span style="color:#fff">test name</span></strong></h3>\n                            </div>\n                        </div>\n\n                    </div>\n                    <!--[if (mso)|(IE)]></td><td style="width: 200px" valign="top" class="w160"><![endif]-->\n                    <div class="column" style="Float: left;max-width: 320px;min-width: 200px; width: 320px;width: calc(72200px - 12000%);text-align: left;color: #8e959c;font-size: 14px;line-height: 21px;font-family: sans-serif;">\n\n                    </div>\n                    <!--[if (mso)|(IE)]></td><td style="width: 200px" valign="top" class="w160"><![endif]-->\n                    <div class="column" style="Float: left;max-width: 320px;min-width: 200px; width: 320px;width: calc(72200px - 12000%);text-align: left;color: #8e959c;font-size: 14px;line-height: 21px;font-family: sans-serif;">\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 10px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                                <h3 class="size-12" style="Margin-top: 0;Margin-bottom: 0;font-style: normal;font-weight: normal;color: #281557;font-size: 12px;line-height: 19px;font-family: Avenir,sans-serif;text-align: center;" lang="x-size-12"><span style="color:#fff"><strong>1.0 Min</strong></span></h3>\n                            </div>\n                        </div>\n\n                    </div>\n                    <!--[if (mso)|(IE)]></td><td class="layout__edges">&nbsp;</td></tr></table><![endif]-->\n                </div>\n            </div>\n        </div>\n\n        <div style="background-color: #281557;">\n            <div class="layout one-col" style="Margin: 0 auto;max-width: 600px;min-width: 320px; width: 320px;width: calc(28000% - 167400px);overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;">\n                <div class="layout__inner" style="border-collapse: collapse;display: table;width: 100%;">\n                    <!--[if (mso)|(IE)]><table width="100%" cellpadding="0" cellspacing="0" role="presentation"><tr class="layout-full-width" style="background-color: #281557;"><td class="layout__edges">&nbsp;</td><td style="width: 600px" class="w560"><![endif]-->\n                    <div class="column" style="max-width: 600px;min-width: 320px; width: 320px;width: calc(28000% - 167400px);text-align: left;color: #8e959c;font-size: 14px;line-height: 21px;font-family: sans-serif;">\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 10px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                    </div>\n                    <!--[if (mso)|(IE)]></td><td class="layout__edges">&nbsp;</td></tr></table><![endif]-->\n                </div>\n            </div>\n        </div>\n\n        <div style="background-color: #4b5462;background-position: 0px 0px;background-image: url(https://i1.createsend1.com/ei/j/D4/D64/348/035447/csfinal/header-img361.jpg);background-repeat: repeat;">\n            <div class="layout one-col" style="Margin: 0 auto;max-width: 600px;min-width: 320px; width: 320px;width: calc(28000% - 167400px);overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;">\n                <div class="layout__inner" style="border-collapse: collapse;display: table;width: 100%;">\n                    <!--[if (mso)|(IE)]><table width="100%" cellpadding="0" cellspacing="0" role="presentation"><tr class="layout-full-width" style="background-color: #4b5462;background-position: 0px 0px;background-image: url(https://i1.createsend1.com/ei/j/D4/D64/348/035447/csfinal/header-img361.jpg);background-repeat: repeat;"><td class="layout__edges">&nbsp;</td><td style="width: 600px" class="w560"><![endif]-->\n                    <div class="column" style="max-width: 600px;min-width: 320px; width: 320px;width: calc(28000% - 167400px);text-align: left;color: #8e959c;font-size: 14px;line-height: 21px;font-family: sans-serif;">\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 110px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                                <h1 class="size-64" style="Margin-top: 0;Margin-bottom: 20px;font-style: normal;font-weight: normal;color: #000;font-size: 44px;line-height: 50px;font-family: avenir,sans-serif;text-align: center;" lang="x-size-64"><span class="font-avenir"><font color="#ffffff"><strong>Predator Test Report</strong></font></span></h1>\n                            </div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 5px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div class="btn btn--flat btn--medium" style="Margin-bottom: 20px;text-align: center;">\n                                <!--[if !mso]--><a style="border-radius: 4px;display: inline-block;font-size: 12px;font-weight: bold;line-height: 22px;padding: 10px 20px;text-align: center;text-decoration: none !important;transition: opacity 0.1s ease-in;color: #ffffff !important;background-color: #e31212;font-family: Avenir, sans-serif;" href=http://report.zooz.com>Html Report</a><!--[endif]-->\n                                <!--[if mso]><p style="line-height:0;margin:0;">&nbsp;</p><v:roundrect xmlns:v="urn:schemas-microsoft-com:vml" href=http://report.zooz.com style="width:110px" arcsize="10%" fillcolor="#E31212" stroke="f"><v:textbox style="mso-fit-shape-to-text:t" inset="0px,9px,0px,9px"><center style="font-size:12px;line-height:22px;color:#FFFFFF;font-family:Avenir,sans-serif;font-weight:bold;mso-line-height-rule:exactly;mso-text-raise:4px">Html Report</center></v:textbox></v:roundrect><![endif]--></div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div class="btn btn--flat btn--medium" style="Margin-bottom: 20px;text-align: center;">\n                                <!--[if !mso]--><a style="border-radius: 4px;display: inline-block;font-size: 12px;font-weight: bold;line-height: 22px;padding: 10px 20px;text-align: center;text-decoration: none !important;transition: opacity 0.1s ease-in;color: #ffffff !important;background-color: #e31212;font-family: Avenir, sans-serif;" href=http://grafana.zooz.com>Grafana Report</a><!--[endif]-->\n                                <!--[if mso]><p style="line-height:0;margin:0;">&nbsp;</p><v:roundrect xmlns:v="urn:schemas-microsoft-com:vml" href=http://grafana.zooz.com style="width:126px" arcsize="10%" fillcolor="#E31212" stroke="f"><v:textbox style="mso-fit-shape-to-text:t" inset="0px,9px,0px,9px"><center style="font-size:12px;line-height:22px;color:#FFFFFF;font-family:Avenir,sans-serif;font-weight:bold;mso-line-height-rule:exactly;mso-text-raise:4px">Grafana Report</center></v:textbox></v:roundrect><![endif]--></div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 85px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                    </div>\n                    <!--[if (mso)|(IE)]></td><td class="layout__edges">&nbsp;</td></tr></table><![endif]-->\n                </div>\n            </div>\n        </div>\n\n        <div style="mso-line-height-rule: exactly;line-height: 15px;font-size: 15px;">&nbsp;</div>\n\n        <div class="layout one-col fixed-width" style="Margin: 0 auto;max-width: 600px;min-width: 320px; width: 320px;width: calc(28000% - 167400px);overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;">\n            <div class="layout__inner" style="border-collapse: collapse;display: table;width: 100%;background-color: #ffffff;">\n                <!--[if (mso)|(IE)]><table align="center" cellpadding="0" cellspacing="0" role="presentation"><tr class="layout-fixed-width" style="background-color: #ffffff;"><td style="width: 600px" class="w560"><![endif]-->\n                <div class="column" style="text-align: left;color: #8e959c;font-size: 14px;line-height: 21px;font-family: sans-serif;max-width: 600px;min-width: 320px; width: 320px;width: calc(28000% - 167400px);">\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div style="mso-line-height-rule: exactly;line-height: 50px;font-size: 1px;">&nbsp;</div>\n                    </div>\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                            <h2 style="Margin-top: 0;Margin-bottom: 16px;font-style: normal;font-weight: normal;color: #e31212;font-size: 26px;line-height: 34px;font-family: Avenir,sans-serif;text-align: center;"><strong>TEST RESULTS</strong></h2>\n                        </div>\n                    </div>\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                            <p style="Margin-top: 0;Margin-bottom: 0;">&nbsp;</p><p style="Margin-top: 20px;Margin-bottom: 20px;"><strong>Test Info:</strong><br>\n                            Test Id: test id<br>\n                            Revision Id:&nbsp;revision_id<br>\n                            Report Id:&nbsp;report_id<br>\n                            Start time: Mon May 28 2018 21:50:59 GMT+0300 (IDT)<br>\n                            End time: Mon May 28 2018 21:51:59 GMT+0300 (IDT)<br>\n                        </div>\n                    </div>\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div class="divider" style="display: block;font-size: 2px;line-height: 2px;Margin-left: auto;Margin-right: auto;width: 40px;background-color: #ccc;Margin-bottom: 20px;">&nbsp;</div>\n                    </div>\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                            <p style="Margin-top: 0;Margin-bottom: 20px;"><strong>Scenarios:</strong><br>\n                                Created: 289448<br>\n                                Completed:&nbsp;289447<br>\n                                Avoided:&nbsp;<br>\n                                <strong>Requests:</strong><br>\n                                Completed: 694611<br>\n                                RPS: 178.61<br>\n                                Pending: 1471</p>\n                        </div>\n                    </div>\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div class="divider" style="display: block;font-size: 2px;line-height: 2px;Margin-left: auto;Margin-right: auto;width: 40px;background-color: #ccc;Margin-bottom: 20px;">&nbsp;</div>\n                    </div>\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                            <p style="Margin-top: 0;Margin-bottom: 20px;"><strong>Request Latency:</strong><br>\n                                Min: 6.3,&nbsp;Max: 3822.8,&nbsp;Median: 58.8,&nbsp;p95: 115.5, p99: 189.4</p>\n                        </div>\n                    </div>\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div class="divider" style="display: block;font-size: 2px;line-height: 2px;Margin-left: auto;Margin-right: auto;width: 40px;background-color: #ccc;Margin-bottom: 20px;">&nbsp;</div>\n                    </div>\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                            <p style="Margin-top: 0;Margin-bottom: 20px;"><strong>Scenario Latency:</strong><br>\n                                Min: 80.4,&nbsp;Max: 5251.7,&nbsp;Median: 146.8,&nbsp;p95: 244.4, p99: 366.6</p>\n                        </div>\n                    </div>\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div class="divider" style="display: block;font-size: 2px;line-height: 2px;Margin-left: auto;Margin-right: auto;width: 40px;background-color: #ccc;Margin-bottom: 20px;">&nbsp;</div>\n                    </div>\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                            <p style="Margin-top: 0;Margin-bottom: 0;"><strong>Codes:</strong><br>\n                                200: 173732, 201: 520878, 503: 1</p>\n                        </div>\n                    </div>\n\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div class="divider" style="display: block;font-size: 2px;line-height: 2px;Margin-left: auto;Margin-right: auto;width: 40px;background-color: #ccc;Margin-bottom: 20px;">&nbsp;</div>\n                    </div>\n\n                    <div style="Margin-left: 20px;Margin-right: 20px;">\n                        <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                            <p style="Margin-top: 0;Margin-bottom: 20px;"><strong>Errors:</strong><br>\n                                EAI_AGAIN: 112, NOTREACH: 123</p>\n                        </div>\n                    </div>\n\n                </div>\n                <!--[if (mso)|(IE)]></td></tr></table><![endif]-->\n            </div>\n        </div>\n\n        <div style="mso-line-height-rule: exactly;line-height: 20px;font-size: 20px;">&nbsp;</div>\n\n        <div style="background-color: #fff;">\n            <div class="layout two-col" style="Margin: 0 auto;max-width: 600px;min-width: 320px; width: 320px;width: calc(28000% - 167400px);overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;">\n                <div class="layout__inner" style="border-collapse: collapse;display: table;width: 100%;">\n                    <!--[if (mso)|(IE)]><table width="100%" cellpadding="0" cellspacing="0" role="presentation"><tr class="layout-full-width" style="background-color: #fff;"><td class="layout__edges">&nbsp;</td><td style="width: 300px" valign="top" class="w260"><![endif]-->\n                    <div class="column" style="Float: left;max-width: 320px;min-width: 300px; width: 320px;width: calc(12300px - 2000%);text-align: left;color: #8e959c;font-size: 14px;line-height: 21px;font-family: sans-serif;">\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 25px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 15px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                    </div>\n                    <!--[if (mso)|(IE)]></td><td style="width: 300px" valign="top" class="w260"><![endif]-->\n                    <div class="column" style="Float: left;max-width: 320px;min-width: 300px; width: 320px;width: calc(12300px - 2000%);text-align: left;color: #8e959c;font-size: 14px;line-height: 21px;font-family: sans-serif;">\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 25px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                    </div>\n                    <!--[if (mso)|(IE)]></td><td class="layout__edges">&nbsp;</td></tr></table><![endif]-->\n                </div>\n            </div>\n        </div>\n\n        <div style="mso-line-height-rule: exactly;line-height: 50px;font-size: 50px;">&nbsp;</div>\n\n        <div style="background-color: #281557;">\n            <div class="layout one-col" style="Margin: 0 auto;max-width: 600px;min-width: 320px; width: 320px;width: calc(28000% - 167400px);overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;">\n                <div class="layout__inner" style="border-collapse: collapse;display: table;width: 100%;">\n                    <!--[if (mso)|(IE)]><table width="100%" cellpadding="0" cellspacing="0" role="presentation"><tr class="layout-full-width" style="background-color: #281557;"><td class="layout__edges">&nbsp;</td><td style="width: 600px" class="w560"><![endif]-->\n                    <div class="column" style="max-width: 600px;min-width: 320px; width: 320px;width: calc(28000% - 167400px);text-align: left;color: #8e959c;font-size: 14px;line-height: 21px;font-family: sans-serif;">\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 50px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                                <h1 class="size-48" style="Margin-top: 0;Margin-bottom: 20px;font-style: normal;font-weight: normal;color: #000;font-size: 36px;line-height: 43px;font-family: Avenir,sans-serif;text-align: center;" lang="x-size-48"><font color="#ffffff" face="avenir, sans-serif"><strong>FOR MORE TESTS VISIT OUR API</strong></font></h1>\n                            </div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 15px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div class="btn btn--flat btn--medium" style="Margin-bottom: 20px;text-align: center;">\n                                <!--[if !mso]--><a style="border-radius: 4px;display: inline-block;font-size: 12px;font-weight: bold;line-height: 22px;padding: 10px 20px;text-align: center;text-decoration: none !important;transition: opacity 0.1s ease-in;color: #e31212 !important;background-color: #ffffff;font-family: sans-serif;" href="https://app.apiary.io/performanceframeworkapi">Tests API</a><!--[endif]-->\n                                <!--[if mso]><p style="line-height:0;margin:0;">&nbsp;</p><v:roundrect xmlns:v="urn:schemas-microsoft-com:vml" href="https://app.apiary.io/performanceframeworkapi" style="width:94px" arcsize="10%" fillcolor="#FFFFFF" stroke="f"><v:textbox style="mso-fit-shape-to-text:t" inset="0px,9px,0px,9px"><center style="font-size:12px;line-height:22px;color:#E31212;font-family:sans-serif;font-weight:bold;mso-line-height-rule:exactly;mso-text-raise:4px">Tests API</center></v:textbox></v:roundrect><![endif]--></div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div style="mso-line-height-rule: exactly;line-height: 35px;font-size: 1px;">&nbsp;</div>\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;">\n                            <div class="btn btn--flat btn--medium" style="Margin-bottom: 20px;text-align: center;">\n                                <!--[if !mso]--><a style="border-radius: 4px;display: inline-block;font-size: 12px;font-weight: bold;line-height: 22px;padding: 10px 20px;text-align: center;text-decoration: none !important;transition: opacity 0.1s ease-in;color: #e31212 !important;background-color: #ffffff;font-family: sans-serif;" href="https://app.apiary.io/performanceframeworkscheduler">Scheduler API</a><!--[endif]-->\n                                <!--[if mso]><p style="line-height:0;margin:0;">&nbsp;</p><v:roundrect xmlns:v="urn:schemas-microsoft-com:vml" href="https://app.apiary.io/performanceframeworkscheduler" style="width:122px" arcsize="10%" fillcolor="#FFFFFF" stroke="f"><v:textbox style="mso-fit-shape-to-text:t" inset="0px,9px,0px,9px"><center style="font-size:12px;line-height:22px;color:#E31212;font-family:sans-serif;font-weight:bold;mso-line-height-rule:exactly;mso-text-raise:4px">Scheduler<br>\n                                API</center></v:textbox></v:roundrect><![endif]--></div>\n                        </div>\n\n                        <div style="font-size: 12px;font-style: normal;font-weight: normal;line-height: 19px;" align="center">\n                            <img style="border: 0;display: block;height: auto;width: 100%;max-width: 192px;" alt="" width="192" src="https://preview.ibb.co/c4crky/Miki_Da_Dawg_Head_Logo_blank.png">\n                        </div>\n\n                        <div style="Margin-left: 20px;Margin-right: 20px;Margin-top: 20px;">\n                            <div style="mso-line-height-rule: exactly;mso-text-raise: 4px;">\n                                <p style="Margin-top: 0;Margin-bottom: 0;">\n                                </p></div>\n                        </div>\n\n                    </div>\n                    <!--[if (mso)|(IE)]></td><td class="layout__edges">&nbsp;</td></tr></table><![endif]-->\n                </div>\n            </div>\n        </div>\n\n        <div style="mso-line-height-rule: exactly;line-height: 20px;font-size: 20px;">&nbsp;</div>\n\n\n        <div style="mso-line-height-rule: exactly;" role="contentinfo">\n            <div class="layout email-footer" style="Margin: 0 auto;max-width: 600px;min-width: 320px; width: 320px;width: calc(28000% - 167400px);overflow-wrap: break-word;word-wrap: break-word;word-break: break-word;">\n                <div class="layout__inner" style="border-collapse: collapse;display: table;width: 100%;">\n                    <!--[if (mso)|(IE)]><table align="center" cellpadding="0" cellspacing="0" role="presentation"><tr class="layout-email-footer"><td style="width: 400px;" valign="top" class="w360"><![endif]-->\n                    <div class="column wide" style="text-align: left;font-size: 12px;line-height: 19px;color: #adb3b9;font-family: sans-serif;Float: left;max-width: 400px;min-width: 320px; width: 320px;width: calc(8000% - 47600px);">\n                        <div style="Margin-left: 20px;Margin-right: 20px;Margin-top: 10px;Margin-bottom: 10px;">\n\n                            <div style="font-size: 12px;line-height: 19px;">\n                                <div>Developed by the NDE Team</div>\n                            </div>\n                            <div style="font-size: 12px;line-height: 19px;Margin-top: 18px;">\n\n                            </div>\n                            <!--[if mso]>&nbsp;<![endif]-->\n                        </div>\n                    </div>\n                    <!--[if (mso)|(IE)]></td><td style="width: 200px;" valign="top" class="w160"><![endif]-->\n                    <div class="column narrow" style="text-align: left;font-size: 12px;line-height: 19px;color: #adb3b9;font-family: sans-serif;Float: left;max-width: 320px;min-width: 200px; width: 320px;width: calc(72200px - 12000%);">\n                        <div style="Margin-left: 20px;Margin-right: 20px;Margin-top: 10px;Margin-bottom: 10px;">\n\n                        </div>\n                    </div>\n                    <!--[if (mso)|(IE)]></td></tr></table><![endif]-->\n                </div>\n            </div>\n        </div>\n        <div style="mso-line-height-rule: exactly;line-height: 40px;font-size: 40px;">&nbsp;</div>\n    </div></td></tr></tbody></table>\n<img style="overflow: hidden;position: fixed;visibility: hidden !important;display: block !important;height: 1px !important;width: 1px !important;border: 0 !important;margin: 0 !important;padding: 0 !important;" src="./report_files/o.gif" width="1" height="1" border="0" alt="">\n\n</body></html>',
                    subject: 'Your test results: test name'

                }
            ]
        ]);

        loggerInfoStub.callCount.should.equal(1);
        loggerInfoStub.args.should.deepEqual([
            [
                { status: 201 },
                'Send email successfully for testId: testId, reportId: reportId'
            ]
        ]);
    });

    it('Send aggregate report fails because of error invoking smtp client', async () => {
        const error = new Error('Failed to connect to SMTP client');
        sendMailStub.resolves({ status: 201 });
        nodemailerCreateTransportStub.throws(error);
        getReportStub.resolves(REPORT);
        getJobStub.resolves(JOB);

        await reportEmailSender.sendAggregateReport('testId', 'reportId', 'REPORT_DATA');

        loggerErrorStub.callCount.should.equal(1);
        loggerErrorStub.args[0][0].should.eql(error);
    });

    it('Error retrieving report', async () => {
        const expectedError = new Error('Failed to retrieve report');
        sendMailStub.resolves({ status: 201 });
        nodemailerCreateTransportStub.returns(transporter);
        getReportStub.rejects(expectedError);
        getJobStub.resolves(JOB);

        let testShouldFail = true;
        try {
            await reportEmailSender.sendAggregateReport('testId', 'reportId', 'REPORT_DATA');
        } catch (error) {
            testShouldFail = false;
            error.message.should.eql('Failed to retrieve summary for testId: testId, reportId: reportId');
            loggerErrorStub.callCount.should.eql(1);
            loggerErrorStub.args[0][0].should.eql(expectedError);
        }

        testShouldFail.should.eql(false, 'Test action was supposed to get exception');
    });

    it('Error retrieving job', async () => {
        const expectedError = new Error('Failed to retrieve job');
        sendMailStub.resolves({ status: 201 });
        nodemailerCreateTransportStub.returns(transporter);
        getReportStub.resolves(REPORT);
        getJobStub.rejects(expectedError);

        let testShouldFail = true;
        try {
            await reportEmailSender.sendAggregateReport('testId', 'reportId', 'REPORT_DATA');
        } catch (error) {
            testShouldFail = false;
            error.message.should.eql('Failed to retrieve summary for testId: testId, reportId: reportId');
            loggerErrorStub.callCount.should.eql(1);
            loggerErrorStub.args[0][0].should.eql(expectedError);
        }

        testShouldFail.should.eql(false, 'Test action was supposed to get exception');
    });
});